#!/bin/bash

# ================= Configuration Area (Modify as needed) =================

# Server list (Hardcoded array)
SERVERS=(
    "192.168.1.101"
    "192.168.1.102"
    # "192.168.1.103"
    "my-web-server.local"
)

# Service name to check (e.g., nginx, mysql, custom-service)
SERVICE_NAME="your-service-name"

# Local file paths
LOCAL_DEB_FILE="./package_name_1.0.0_amd64.deb"
LOCAL_CONF_FILE="./your-config.conf"

# Remote temporary directory
REMOTE_TMP_DIR="/tmp"

# Remote config destination path (Where to place config after installation)
REMOTE_CONF_DEST="/etc/your-service/config.conf"

# SSH User
SSH_USER="root"

# ===============================================================

# Color definitions
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Starting batch deployment task...${NC}"
echo -e "Target Service: ${SERVICE_NAME}"
echo "------------------------------------------------------"

# Iterate through the hardcoded server list
for SERVER in "${SERVERS[@]}"; do
    # Skip empty lines or comments
    [[ $SERVER =~ ^#.*$ ]] || [[ -z $SERVER ]] && continue

    echo -e "Processing Server: ${GREEN}$SERVER${NC} ..."

    # 1. Check connection
    ssh -o ConnectTimeout=5 -o BatchMode=yes "$SSH_USER@$SERVER" exit &>/dev/null
    if [ $? -ne 0 ]; then
        echo -e "  [${RED}Connection Failed${NC}] Unable to connect to $SERVER, skipping."
        continue
    fi

    # 2. Check if Service exists
    if ssh "$SSH_USER@$SERVER" "systemctl list-unit-files | grep -q ^${SERVICE_NAME}.service"; then
        echo -e "  [${YELLOW}Skipped${NC}] Service ($SERVICE_NAME) already exists."
    else
        echo -e "  [${GREEN}Installing${NC}] Service not found, starting deployment..."

        # 3. SCP files to remote
        echo "    -> Uploading files..."
        
        # Ensure remote temp directory exists before SCP
        ssh "$SSH_USER@$SERVER" "mkdir -p $REMOTE_TMP_DIR"

        scp "$LOCAL_DEB_FILE" "$LOCAL_CONF_FILE" "$SSH_USER@$SERVER:$REMOTE_TMP_DIR/"
        
        if [ $? -ne 0 ]; then
            echo -e "    [${RED}Error${NC}] SCP upload failed."
            continue
        fi

        # 4. Remote installation and configuration
        DEB_FILENAME=$(basename "$LOCAL_DEB_FILE")
        CONF_FILENAME=$(basename "$LOCAL_CONF_FILE")

        echo "    -> Executing installation and configuration..."
        
        # [UPDATED ORDER]: Move Config -> Install Package -> Start Service
        ssh "$SSH_USER@$SERVER" "bash -s" <<EOF
            # Step A: Move Config file FIRST (Pre-seeding config)
            # We create the directory first because the package isn't installed yet
            echo "       Setting up configuration..."
            mkdir -p $(dirname "$REMOTE_CONF_DEST")
            mv $REMOTE_TMP_DIR/$CONF_FILENAME "$REMOTE_CONF_DEST"

            # Step B: Install .deb Package
            echo "       Installing package..."
            dpkg -i $REMOTE_TMP_DIR/$DEB_FILENAME
            
            # Fix missing dependencies if needed (Optional)
            # apt-get install -f -y 

            # Step C: Reload Daemon and Ensure Service is Started
            echo "       Starting service..."
            systemctl daemon-reload
            systemctl enable $SERVICE_NAME
            systemctl restart $SERVICE_NAME

            # Step D: Clean up temp files
            rm -f $REMOTE_TMP_DIR/$DEB_FILENAME
EOF

        if [ $? -eq 0 ]; then
             echo -e "  [${GREEN}Success${NC}] $SERVER deployment completed!"
        else
             echo -e "  [${RED}Failed${NC}] Error occurred during installation on $SERVER."
        fi
    fi
    echo "------------------------------------------------------"

done

echo -e "${YELLOW}All tasks finished.${NC}"
