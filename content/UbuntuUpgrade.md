# 智慧型 Ubuntu 雙階段升級腳本指南

## 1. 總覽

這份文件是關於 `smart_upgrade.sh` 腳本的使用與技術指南。此腳本的核心目標是提供一個**全自動、可靠且安全**的解決方案，用以將 Ubuntu 伺服器從 `20.04 LTS` 版本，經過兩個階段，平滑地升級到 `24.04 LTS` 版本。

所謂「智慧型」，是指腳本能**自動偵測**當前的作業系統版本，並執行該版本對應的升級任務，使用者只需在不同階段執行同一個腳本即可。

---

## 2. 核心功能

此腳本整合了多個關鍵的系統管理任務，以確保升級過程的順利與穩定：

* **智慧型版本偵測**：自動判斷系統是 20.04 還是 22.04，並執行正確的升級路徑。
* **分離的代理設定**：腳本能夠分別處理兩種代理：一個用於 `apt` 套件管理器（例如，連線到內部的 `apt-cacher-ng` 快取伺服器），另一個則作為全域的環境代理，供 `curl` 或 `do-release-upgrade` 等工具連線到外部網路。
* **網路環境配置**：自動安裝指定的 CA 憑證，確保升級過程中的網路連線暢通。
* **系統升級前穩定化**：在升級前，執行一套完整的系統更新、套件修復與清理程序，將系統調整至最穩定的狀態。
* **PAM 模組現代化**：自動將舊版的登入失敗計數模組 (`pam_tally`) 轉換為現代標準的 `pam_faillock`，解決了從 20.04 升級後的潛在登入問題。此過程採用了最標準的 `pam-auth-update` 機制。
* **客製化設定清理**：自動處理升級前可能引起衝突的特定設定，例如停用指定的 Vim 外掛，以及調整 AIDE 的忽略規則以避免產生大量無用警報。
* **連線驗證**：在啟動升級程序前，主動測試**環境代理**是否能連線至 Ubuntu 的更新伺服器，預防因網路問題導致的升級中斷。
* **自動化升級**：在使用者最終確認後，以非互動模式執行 `do-release-upgrade`，將手動介入降到最低。

---

## 3. 使用方法

請依照以下步驟操作，以完成從 20.04 到 24.04 的完整升級。

### 步驟 1：編輯腳本與上傳
-   打開 `smart_upgrade.sh` 腳本檔案。
-   找到 `CA_CERT_CONTENT` 變數區塊。
-   將您的 CA 憑證完整內容（包含 `-----BEGIN CERTIFICATE-----` 和 `-----END CERTIFICATE-----`）貼入引號之間。
-   儲存檔案，並將其上傳到您要升級的 Ubuntu 20.04 伺服器上。

### 步驟 2：賦予執行權限
在伺服器的終端機中，執行以下指令：
```bash
chmod +x smart_upgrade.sh
```

### 步驟 3：執行第一階段升級 (20.04 → 22.04)
-   確保您當前的系統是 Ubuntu 20.04，然後執行腳本：
    ```bash
    sudo ./smart_upgrade.sh
    ```
-   腳本會開始執行所有第一階段的準備工作，然後啟動 `do-release-upgrade`。
-   您只需在腳本一開始的安全提示下輸入 `Y` 確認，後續的升級過程將會自動進行。

### 步驟 4：重新啟動系統
-   當第一階段升級完成後，`do-release-upgrade` 工具會提示您重新啟動系統。請依照指示重啟。
-   重啟後，您的系統版本應為 Ubuntu 22.04。

### 步驟 5：執行第二階段升級 (22.04 → 24.04)
-   登入到已升級至 22.04 的系統中。
-   **再次執行同一個腳本**：
    ```bash
    sudo ./smart_upgrade.sh
    ```
-   腳本會偵測到您現在的系統是 22.04，並自動執行第二階段的精簡版準備工作，然後啟動到 24.04 的升級。

### 步驟 6：完成升級
-   當第二階段升級完成後，再次依照提示重新啟動系統。
-   恭喜！您的伺服器現在已成功升級至 Ubuntu 24.04 LTS。

---

## 4. 各階段詳細流程

### 第一階段 (20.04 → 22.04)
當腳本偵測到系統為 20.04 時，會執行以下所有準備工作：

1.  **`setup_proxy`**: **首次設定代理**。它會將 `APT_PROXY_URL` (3142) 寫入 APT 設定，並將 `ENV_PROXY_URL` (8080) 寫入全域環境變數。
2.  **`install_and_update_ca`**: 首次安裝 CA 憑證。
3.  **`stabilize_system`**: 進行全面的系統更新與清理，為升級打下穩定基礎。
4.  **`update_pam_configuration_standard`**: **此為關鍵步驟**。它會移除舊的 `pam_tally` 模組，並透過 `pam-auth-update` 的標準機制設定 `pam_faillock`，確保升級到 22.04 後登入功能正常。
5.  **`handle_vim_plugin_cleanup`**: 註解掉 `.vimrc` 中指定的 Vim 外掛 (`vim-fugitive`, `indentLine`)，並執行 `PlugClean` 清理。
6.  **`configure_aide`**: 修改 AIDE 設定檔，加入對 `/var/log`, `/run`, `/tmp`, `/data` 等目錄的忽略規則。
7.  **`run_release_upgrade`**:
    -   執行代理連線驗證。
    -   在您手動確認後，以非互動模式啟動升級程序。

### 第二階段 (22.04 → 24.04)
當您在 22.04 系統上再次執行腳本時，它會執行一套精簡的流程：

1.  **`verify_proxy_and_ca`**: 不會重新安裝，而是檢查代理與 CA 憑證的設定檔是否存在。如果因故遺失，才會觸發重新安裝。
2.  **`stabilize_system`**: 升級前再次進行系統穩定化，這是每次升級都必要的步驟。
3.  **`run_release_upgrade`**:
    -   再次執行代理連線驗證。
    -   在您確認後，啟動到 24.04 的升級。

此階段**不會**再次執行 PAM、Vim 或 AIDE 的設定，因為這些設定在第一階段就已完成，無需重複。

---

## 5. 注意事項

* **備份**：在執行此腳本前，請務必對您的重要資料和系統設定進行完整備份。
* **Root 權限**：腳本需要 `sudo` 權限才能修改系統檔案。
* **保持連線**：建議在 `screen` 或 `tmux` 等終端機多工器中執行此腳本，以防 SSH 連線中斷導致升級失敗。
* **適用版本**：此腳本是專為 Ubuntu 20.04 / 22.04 設計的，請勿在其他版本上執行。
